<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="d-flex justify-content-center align-items-center vh-100 bg-light">
  <div class="card shadow-sm p-4" style="width: 380px; border-radius: 12px;">

    <h3 class="text-center fw-bold mb-3">Tạo tài khoản</h3>

    {{#if error}}
      <div class="alert alert-danger py-2">{{error}}</div>
    {{/if}}

    <form method="POST" action="/register" class="d-flex flex-column gap-3">

      <!-- NAME -->
      <div>
        <label for="name" class="form-label fw-semibold">Họ và tên</label>
        <input 
          type="text" 
          class="form-control" 
          name="name" 
          id="name"
          placeholder="Nhập họ và tên"
          required
        >
      </div>

      <!-- EMAIL -->
      <div>
        <label for="email" class="form-label fw-semibold">Email</label>
        <input 
          type="email" 
          class="form-control" 
          name="email" 
          id="email"
          placeholder="example@gmail.com"
          required
        >
        <div id="email-message" class="mt-1" style="font-size: 14px;"></div>
      </div>

      <!-- PHONE -->
      <div>
        <label for="phone" class="form-label fw-semibold">Số điện thoại</label>
        <input 
          type="text" 
          class="form-control" 
          name="phone" 
          id="phone"
          placeholder="Nhập số điện thoại"
          required
        >
        <div id="phone-message" class="mt-1" style="font-size: 14px;"></div>
      </div>

      <!-- PASSWORD -->
      <div>
        <label for="password" class="form-label fw-semibold">Mật khẩu</label>
        <div class="input-group">
          <input 
            type="password" 
            class="form-control"
            id="password"
            name="password"
            placeholder="Mật khẩu mạnh (ít nhất 12 ký tự)"
            required
          >
          <span class="input-group-text toggle-password" data-target="#password" style="cursor: pointer;">
            <i class="bi bi-eye-slash"></i>
          </span>
        </div>

        <ul class="mt-2" id="password-rules" style="font-size: 14px; list-style: none; padding-left: 0;">
          <li id="rule-length" class="text-danger">• Ít nhất 12 ký tự</li>
          <li id="rule-upper" class="text-danger">• Có chữ hoa (A–Z)</li>
          <li id="rule-lower" class="text-danger">• Có chữ thường (a–z)</li>
          <li id="rule-number" class="text-danger">• Có số (0–9)</li>
          <li id="rule-special" class="text-danger">• Có ký tự đặc biệt (!@#$%^&*...)</li>
        </ul>
      </div>

      <!-- CONFIRM PASSWORD -->
      <div>
        <label for="confirmPassword" class="form-label fw-semibold">Nhập lại mật khẩu</label>
        <div class="input-group">
          <input 
            type="password" 
            class="form-control"
            id="confirmPassword"
            name="confirmPassword"
            placeholder="Nhập lại mật khẩu"
            required
          >
          <span class="input-group-text toggle-password" data-target="#confirmPassword" style="cursor: pointer;">
            <i class="bi bi-eye-slash"></i>
          </span>
        </div>

        <div id="match-message" class="mt-1" style="font-size: 14px;"></div>
      </div>

      <!-- SUBMIT BUTTON -->
      <button type="submit" class="btn btn-dark w-100 fw-semibold" id="btn-register" disabled>
        Đăng ký
      </button>

      <div class="text-center mt-2">
        Bạn đã có tài khoản?
        <a href="/login" class="fw-semibold">Đăng nhập</a>
      </div>

    </form>

  </div>
</div>

<script>
  // Toggle eye icon
  document.querySelectorAll('.toggle-password').forEach(icon => {
    icon.addEventListener('click', () => {
      const input = document.querySelector(icon.getAttribute('data-target'));
      const isPassword = input.type === "password";

      input.type = isPassword ? "text" : "password";
      icon.querySelector('i').classList.toggle('bi-eye');
      icon.querySelector('i').classList.toggle('bi-eye-slash');
    });
  });

  // Get input fields
  const passwordInput = document.getElementById('password');
  const confirmInput = document.getElementById('confirmPassword');
  const submitBtn     = document.getElementById('btn-register');

  const matchMessage  = document.getElementById('match-message');

  const emailInput = document.getElementById('email');
  const phoneInput = document.getElementById('phone');

  const emailMessage = document.getElementById('email-message');
  const phoneMessage = document.getElementById('phone-message');


  // Validate email
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // Validate Vietnamese phone number
  function isVietnamPhoneNumber(phone) {
    const p = phone.replace(/[\s\-().]/g, '');
    return /^(\+84|0)(3|5|7|8|9)\d{8}$/.test(p);
  }


  function validateForm() {
    const pass        = passwordInput.value;
    const confirmPass = confirmInput.value;
    const email       = emailInput.value;
    const phone       = phoneInput.value;

    // PASSWORD CONDITIONS
    const conditions = {
      length: pass.length >= 12,
      upper: /[A-Z]/.test(pass),
      lower: /[a-z]/.test(pass),
      number: /[0-9]/.test(pass),
      special: /[^A-Za-z0-9]/.test(pass)
    };

    updateRule("rule-length", conditions.length);
    updateRule("rule-upper", conditions.upper);
    updateRule("rule-lower", conditions.lower);
    updateRule("rule-number", conditions.number);
    updateRule("rule-special", conditions.special);

    const passwordStrong = Object.values(conditions).every(v => v === true);

    // CONFIRM PASSWORD
    const match = pass !== "" && pass === confirmPass;

    if (confirmPass === "") {
      matchMessage.textContent = "";
    } else if (match) {
      matchMessage.textContent = "Mật khẩu trùng khớp";
      matchMessage.className = "text-success mt-1";
    } else {
      matchMessage.textContent = "Mật khẩu không khớp";
      matchMessage.className = "text-danger mt-1";
    }

    // EMAIL CHECK
    const emailValid = isValidEmail(email);
    if (email === "") {
      emailMessage.textContent = "";
    } else if (emailValid) {
      emailMessage.textContent = "Email hợp lệ";
      emailMessage.className = "text-success mt-1";
    } else {
      emailMessage.textContent = "Email không hợp lệ";
      emailMessage.className = "text-danger mt-1";
    }

    // PHONE CHECK
    const phoneValid = isVietnamPhoneNumber(phone);
    if (phone === "") {
      phoneMessage.textContent = "";
    } else if (phoneValid) {
      phoneMessage.textContent = "Số điện thoại hợp lệ";
      phoneMessage.className = "text-success mt-1";
    } else {
      phoneMessage.textContent = "Số điện thoại không hợp lệ";
      phoneMessage.className = "text-danger mt-1";
    }

    // ENABLE SUBMIT BUTTON ONLY WHEN ALL VALID
    submitBtn.disabled = !(passwordStrong && match && emailValid && phoneValid);
  }


  // Update password rule colors
  function updateRule(id, ok) {
    const el = document.getElementById(id);
    if (ok) {
      el.classList.remove("text-danger");
      el.classList.add("text-success");
    } else {
      el.classList.remove("text-success");
      el.classList.add("text-danger");
    }
  }

  // Listen input events
  passwordInput.addEventListener('input', validateForm);
  confirmInput.addEventListener('input', validateForm);
  emailInput.addEventListener('input', validateForm);
  phoneInput.addEventListener('input', validateForm);
</script>
