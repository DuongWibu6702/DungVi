<div class="container mt-5">

    <h2 class="fw-bold mb-4">Quản lý người dùng</h2>

    <!-- Search + Filter -->
    <form method="GET" action="/admin/users" class="row g-3 mb-4">

        <div class="col-md-4">
            <input type="text" name="q"
                placeholder="Tìm theo tên, email..."
                class="form-control"
                value="{{query.q}}">
        </div>

        <div class="col-md-3">
            <select name="role" class="form-select">
                <option value="">Tất cả vai trò</option>
                <option value="admin"  {{#if (eq query.role "admin")}}selected{{/if}}>Admin</option>
                <option value="author" {{#if (eq query.role "author")}}selected{{/if}}>Author</option>
                <option value="member" {{#if (eq query.role "member")}}selected{{/if}}>Member</option>
            </select>
        </div>

        <div class="col-md-2 d-grid">
            <button class="btn btn-dark">Lọc</button>
        </div>

        <div class="col-md-2 d-grid">
            <a href="/admin/users" class="btn btn-secondary">Reset</a>
        </div>

    </form>

    <!-- Bảng user -->
    <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark text-center">
            <tr>
                <th>#</th>
                <th>Họ tên</th>
                <th>Email</th>
                <th>Vai trò</th>
                <th style="width: 260px;">Hành động</th>
            </tr>
        </thead>

        <tbody>
        {{#each users}}
            <tr>
                <td class="text-center">{{inc @index}}</td>
                <td>{{this.name}}</td>
                <td>{{this.email}}</td>

                <td class="text-center">
                    <span class="badge text-bg-primary text-uppercase px-3 py-2">
                        {{this.type}}
                    </span>

                    {{#if (eq this.type "Author")}}
                        {{#if this.active}}
                            <span class="badge bg-success ms-2 px-3 py-2">ACTIVE</span>
                        {{else}}
                            <span class="badge bg-danger ms-2 px-3 py-2">INACTIVE</span>
                        {{/if}}
                    {{/if}}
                </td>

                <td class="text-center">

                    {{!-- Chuyển loại Member <-> Author --}}
                    {{#unless (eq this.type "Admin")}}
                        <form method="POST"
                            action="/admin/users/{{this._id}}/change-type?_method=PATCH"
                            class="d-inline-block me-1">

                            <select name="newType"
                                    class="form-select form-select-sm d-inline-block"
                                    style="width: 135px; display:inline-block;">
                                <option value="Member" {{#if (eq this.type "Member")}}selected{{/if}}>Member</option>
                                <option value="Author" {{#if (eq this.type "Author")}}selected{{/if}}>Author</option>
                            </select>

                            <button class="btn btn-primary btn-sm mt-1">Chuyển</button>
                        </form>
                    {{/unless}}

                    {{!-- Active / Inactive --}}
                    {{#if (eq this.type "Author")}}
                        <form method="POST"
                              action="/admin/users/{{this._id}}/toggle-active?_method=PATCH"
                              class="d-inline">
                            {{#if this.active}}
                                <button class="btn btn-warning btn-sm">Deactivate</button>
                            {{else}}
                                <button class="btn btn-success btn-sm">Activate</button>
                            {{/if}}
                        </form>
                    {{/if}}

                    {{!-- XÓA BẰNG MODAL --}}
                    {{#unless (eq this.type "Admin")}}
                        <button type="button"
                                class="btn btn-danger btn-sm ms-1 btn-delete"
                                data-id="{{this._id}}"
                                data-name="{{this.name}}"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteUserModal">
                            Xóa
                        </button>

                        <!-- Form delete ẩn -->
                        <form id="deleteForm_{{this._id}}"
                              method="POST"
                              action="/admin/users/{{this._id}}/delete?_method=DELETE"
                              class="d-none"></form>
                    {{/unless}}

                </td>
            </tr>
        {{/each}}
        </tbody>
    </table>

</div>


<!-- MODAL XÓA USER -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Xác nhận xóa người dùng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p>Bạn có chắc muốn xóa người dùng:</p>
        <h5 id="deleteUserName" class="fw-bold text-danger"></h5>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>

        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
            Xóa
        </button>
      </div>

    </div>
  </div>
</div>

<script src="/js/admin/users.js"></script>