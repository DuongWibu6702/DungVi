<div class="container mt-5">

    <h2 class="fw-bold mb-4">Quản lý người dùng</h2>

    <!-- Search + Filter -->
    <form method="GET" action="/admin/users" class="row g-3 mb-4">

        <div class="col-md-4">
            <input type="text" name="q"
                placeholder="Tìm theo tên, email, số điện thoại..."
                class="form-control"
                value="{{query.q}}">
        </div>

        <div class="col-md-3">
            <select name="role" class="form-select">
                <option value="">Tất cả vai trò</option>
                <option value="admin" {{#if (eq query.role "admin")}}selected{{/if}}>Admin</option>
                <option value="author" {{#if (eq query.role "author")}}selected{{/if}}>Author</option>
                <option value="member" {{#if (eq query.role "member")}}selected{{/if}}>Member</option>
            </select>
        </div>

        <div class="col-md-2 d-grid">
            <button class="btn btn-dark">Lọc</button>
        </div>

        <div class="col-md-2 d-grid">
            <a href="/admin/users" class="btn btn-secondary">Reset</a>
        </div>

    </form>

    <!-- BẢNG USER -->
    <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark text-center">
            <tr>
                <th>#</th>
                <th>Họ tên</th>
                <th>Email</th>
                <th>SĐT</th>
                <th>Vai trò</th>
                <th style="width: 200px;">Hành động</th>
            </tr>
        </thead>

        <tbody>
            {{#each users}}
            <tr>
                <td class="text-center">{{inc @index}}</td>

                <td>{{this.name}}</td>
                <td>{{this.email}}</td>
                <td>{{this.phone}}</td>

                <td class="text-center">
                    <span class="badge text-bg-primary text-uppercase px-3 py-2">
                        {{this.role}}
                    </span>
                </td>

                <td class="text-center">
                    <button class="btn btn-sm btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#roleModal-{{this._id}}">
                        Đổi vai trò
                    </button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>


    <!-- RENDER TOÀN BỘ MODAL RA NGOÀI TABLE -->
    {{#each users}}
    <div class="modal fade" id="roleModal-{{this._id}}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <form method="POST" action="/admin/users/{{this._id}}/role" class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Đổi vai trò: {{this.name}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <label class="fw-bold mb-2">Chọn vai trò mới:</label>
                    <select name="role" class="form-select">
                        <option value="admin" {{#if (eq this.role "admin")}}selected{{/if}}>Admin</option>
                        <option value="author" {{#if (eq this.role "author")}}selected{{/if}}>Author</option>
                        <option value="member" {{#if (eq this.role "member")}}selected{{/if}}>Member</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>

            </form>
        </div>
    </div>
    {{/each}}


    <!-- PHÂN TRANG -->
    {{#if pagination.totalPages}}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">

            <li class="page-item {{#if pagination.isFirst}}disabled{{/if}}">
                <a class="page-link" href="?page={{pagination.prev}}{{queryString query}}">«</a>
            </li>

            {{#each pagination.pages}}
            <li class="page-item {{#if this.active}}active{{/if}}">
                <a class="page-link" href="?page={{this.number}}{{queryString ../query}}">
                    {{this.number}}
                </a>
            </li>
            {{/each}}

            <li class="page-item {{#if pagination.isLast}}disabled{{/if}}">
                <a class="page-link" href="?page={{pagination.next}}{{queryString query}}">»</a>
            </li>

        </ul>
    </nav>
    {{/if}}

</div>
